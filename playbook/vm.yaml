---
- name: Provisionamiento de VM con Cloud-Init
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    node_name: "{{ node }}"
    mem: 8192
    cpu: 4
    bridge_gw: "192.168.122.1"
    # Calculamos la raíz del proyecto (un nivel arriba de donde está el playbook)
    project_root: "{{ playbook_dir | dirname }}"
    data_path: "{{ project_root }}/data"
    template_image: "{{ data_path }}/TEMPLATE.qcow2"

  tasks:
    - name: Configuración de entorno y resolución de IP
      tags: [always, prep]  # 'always' asegura que vm_ip se resuelva aunque uses otros tags
      block:
        - name: Validar definición de nodo
          fail:
            msg: "Falta variable 'node'. Ej: -e 'node=node01'"
          when: node_name is not defined

        - name: Obtener IP mediante resolución de nombres
          set_fact:
            vm_ip: "{{ lookup('community.general.dig', node_name) }}"
          failed_when: vm_ip == "" or vm_ip == "NXDOMAIN"

    - name: Preparar imagen de disco
      tags: [vm_image]
      copy:
        src: "{{ template_image }}"
        dest: "{{ data_path }}/{{ node_name }}.qcow2"
        force: yes
        mode: '0664'

    - name: Preparar Cloud-Init
      tags: [cloud_init_config]
      block:
        - name: Leer clave pública SSH
          slurp:
            src: "{{ data_path }}/keys.pub"
          register: ssh_keys_encoded

        - name: Generar archivos temporales Cloud-Init
          template:
            src: "{{ project_root }}/templates/{{ item.src }}"
            dest: "{{ data_path }}/{{ item.dest }}-{{ node_name }}"
          loop:
            - { src: "user-data.j2", dest: "user-data" }
            - { src: "meta-data.j2", dest: "meta-data" }
            - { src: "network-config.j2", dest: "network-config" }

    - name: Crear ISO de Cloud-Init
      tags: [cloud_init_iso]
      command: >
        cloud-localds -N {{ data_path }}/network-config-{{ node_name }}
        {{ data_path }}/cloud-init-{{ node_name }}.iso
        {{ data_path }}/user-data-{{ node_name }}
        {{ data_path }}/meta-data-{{ node_name }}
      args:
        creates: "{{ data_path }}/cloud-init-{{ node_name }}.iso"


    - name: Despliegue con virt-install
      tags: [virt_deploy]
      block:
        - name: Comprobar si la VM ya existe
          command: "virsh dominfo {{ node_name }}"
          register: vm_exists
          failed_when: false
          changed_when: false

        - name: Instalar VM usando virt-install
          shell: >
            /usr/bin/virt-install
            --name {{ node_name }}
            --memory {{ mem }}
            --vcpus {{ cpu }}
            --disk path={{ data_path }}/{{ node_name }}.qcow2,format=qcow2
            --disk path={{ data_path }}/cloud-init-{{ node_name }}.iso,device=cdrom
            --os-variant generic
            --network network=default,model=virtio
            --import
            --graphics none
            --noautoconsole
          when: vm_exists.rc != 0
          register: virt_install_res

        - name: Limpiar known_hosts
          known_hosts:
            name: "{{ node_name }}"
            state: absent

        - name: Esperar a Cloud-Init vía SSH
          shell: "ssh -o StrictHostKeyChecking=no -i {{ data_path }}/keys root@{{ node_name }} 'cloud-init status --wait'"
          register: cloud_init_wait
          until: cloud_init_wait.rc == 0
          retries: 30
          delay: 10

    - name: Resultado final
      tags: [always]
      debug:
        msg: "Nodo {{ node_name }} desplegado correctamente en {{ vm_ip }}"
